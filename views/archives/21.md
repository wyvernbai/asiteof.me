要使用Varnish负载均衡器，首先用户需要在配置文件中加入了相应的“director”关键字（2.0.4版中只有random和round-robin均衡器），并用VCL语言为此“director”分配好后端服务器。举例如下：

```
backend breadtalk {
.host = “202.102.58.241″;
.port = “80″;
}
director footoo round-robin {
{ .backend = { .host = “210.51.**.**”; .port = “80″; } }
{ .backend = { .host = “221.231.**.**”; .port = “80″; } }
{ .backend = { .host = “210.51.**.**”; .port = “80″; } }
}
```

当Varnish启动时配置文件被VCL_complier解析，将包含director的所有配置信息，转化成C语言函数写入一个临时文件中，编译此文件生成动态链接库，供响应Http请求时选取相应策略。

下面先从配置文件的解析开始，对实现的方法进行比较。

在我们的实现方式中，在vcc_backend.c文件中director的解析列表里加入“ip-hash”关键字。调用加入的函数vcc_ParseIpHashDirector对director ip-hash的配置进行解析，将ip-hash的配置转化成C语言代码，加入临时文件中。

varnish的解析函数主要存放在lib/libvcl目录下,其中vcc_parse.c文件中的结构体:

<div style="background: rgb(253, 253, 253) none repeat scroll 0% 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; color: black;"><u>C语言</u></div><div style="font-family: "[object HTMLOptionElement]","Courier New","Bitstream Vera Sans Mono","monospace"; color: rgb(0, 0, 0);" class="source"><span style="color: rgb(0, 136, 0); font-style: italic;">01</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">static</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">toplev</span> <span style="color: rgb(0, 0, 0);">{</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">02</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">const</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">char</span>  <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">name</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">03</span>     <span style="color: rgb(0, 0, 0);">parse_f</span>     <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">func</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">04</span> <span style="color: rgb(0, 0, 0);">}</span> <span style="color: rgb(0, 0, 0);">toplev</span><span style="color: rgb(0, 0, 0);">[]</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 0);">{</span><br /><span style="color: rgb(248, 16, 176);">05</span>     <span style="color: rgb(0, 0, 0);">{</span> <span style="color: rgb(0, 0, 255);">"acl"</span><span style="color: rgb(0, 0, 0);">,</span>        <span style="color: rgb(0, 0, 0);">vcc_Acl</span> <span style="color: rgb(0, 0, 0);">},</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">06</span>     <span style="color: rgb(0, 0, 0);">{</span> <span style="color: rgb(0, 0, 255);">"sub"</span><span style="color: rgb(0, 0, 0);">,</span>        <span style="color: rgb(0, 0, 0);">vcc_Function</span> <span style="color: rgb(0, 0, 0);">},</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">07</span>     <span style="color: rgb(0, 0, 0);">{</span> <span style="color: rgb(0, 0, 255);">"backend"</span><span style="color: rgb(0, 0, 0);">,</span>        <span style="color: rgb(0, 0, 0);">vcc_ParseDirector</span> <span style="color: rgb(0, 0, 0);">},</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">08</span>     <span style="color: rgb(0, 0, 0);">{</span> <span style="color: rgb(0, 0, 255);">"director"</span><span style="color: rgb(0, 0, 0);">,</span>       <span style="color: rgb(0, 0, 0);">vcc_ParseDirector</span> <span style="color: rgb(0, 0, 0);">},</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">09</span>     <span style="color: rgb(0, 0, 0);">{</span> <span style="color: rgb(0, 0, 0);">NULL</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">NULL</span> <span style="color: rgb(0, 0, 0);">}</span><br /><span style="color: rgb(248, 16, 176);">10</span> <span style="color: rgb(0, 0, 0);">};</span><br /></div>
记录了解析acl, sub, backend, director用到的函数。
项目涉及的url hash和ip hash属于director解析范畴之内，我们进入vcc_ParseDirector（/lib/libvcl/backend.c文件内）

<div style="background: rgb(253, 253, 253) none repeat scroll 0% 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; color: black;"><u>C语言</u></div><div style="font-family: "[object HTMLOptionElement]","Courier New","Bitstream Vera Sans Mono","monospace"; color: rgb(0, 0, 0);" class="source"><span style="color: rgb(0, 136, 0); font-style: italic;">01</span> <span style="color: rgb(0, 136, 0); font-style: italic;">/*现在着重对vcc_ParseDirector函数进行下分析*/</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">02</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">static</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">const</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">dirlist</span> <span style="color: rgb(0, 0, 0);">{</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">03</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">const</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">char</span>  <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">name</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">04</span>     <span style="color: rgb(0, 0, 0);">parsedirector_f</span> <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">func</span>;<br /><span style="color: rgb(248, 16, 176);">05</span> <span style="color: rgb(0, 0, 0);">}</span> <span style="color: rgb(0, 0, 0);">dirlist</span><span style="color: rgb(0, 0, 0);">[]</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 0);">{</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">06</span>     <span style="color: rgb(0, 0, 0);">{</span> <span style="color: rgb(0, 0, 255);">"random"</span><span style="color: rgb(0, 0, 0);">,</span>     <span style="color: rgb(0, 0, 0);">vcc_ParseRandomDirector</span> <span style="color: rgb(0, 0, 0);">},</span>          <span style="color: rgb(0, 136, 0); font-style: italic;">/*不同的负载均衡方式对应不同的解析方式,因为不同的负载均衡方式对应的配置方式有所不同*/</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">07</span>     <span style="color: rgb(0, 0, 0);">{</span> <span style="color: rgb(0, 0, 255);">"round-robin"</span><span style="color: rgb(0, 0, 0);">,</span>    <span style="color: rgb(0, 0, 0);">vcc_ParseRoundRobinDirector</span> <span style="color: rgb(0, 0, 0);">},</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">08</span>     <span style="color: rgb(0, 0, 0);">{</span> <span style="color: rgb(0, 0, 0);">NULL</span><span style="color: rgb(0, 0, 0);">,</span>     <span style="color: rgb(0, 0, 0);">NULL</span> <span style="color: rgb(0, 0, 0);">}</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">09</span> <span style="color: rgb(0, 0, 0);">};</span><br /><span style="color: rgb(248, 16, 176);">10</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">11</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">void</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">12</span> <span style="color: rgb(0, 0, 0);">vcc_ParseDirector</span>(<span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">tokenlist</span> <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">tl</span>)<br /><span style="color: rgb(0, 136, 0); font-style: italic;">13</span> <span style="color: rgb(0, 0, 0);">{</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">14</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">token</span> <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">t_dir</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">t_first</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">t_policy</span>;<br /><span style="color: rgb(248, 16, 176);">15</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">dirlist</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">const</span> <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">dl</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">16</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">17</span>     <span style="color: rgb(0, 0, 0);">t_first</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 0);">tl</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">t</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">18</span>     <span style="color: rgb(0, 0, 0);">vcc_NextToken</span>(<span style="color: rgb(0, 0, 0);">tl</span>);      <span style="color: rgb(0, 136, 0); font-style: italic;">/* ID: director | backend */</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">19</span> <br /><span style="color: rgb(248, 16, 176);">20</span>     <span style="color: rgb(0, 0, 0);">vcc_ExpectCid</span>(<span style="color: rgb(0, 0, 0);">tl</span>);      <span style="color: rgb(0, 136, 0); font-style: italic;">/* ID: name */</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">21</span>     <span style="color: rgb(0, 0, 0);">ERRCHK</span>(<span style="color: rgb(0, 0, 0);">tl</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">22</span>     <span style="color: rgb(0, 0, 0);">t_dir</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 0);">tl</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">t</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">23</span>     <span style="color: rgb(0, 0, 0);">vcc_NextToken</span>(<span style="color: rgb(0, 0, 0);">tl</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">24</span> <br /><span style="color: rgb(248, 16, 176);">25</span>     <span style="color: rgb(0, 0, 0);">Fh</span>(<span style="color: rgb(0, 0, 0);">tl</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 255);">1</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 255);">"</span><span style="color: rgb(0, 0, 255);">\n</span><span style="color: rgb(0, 0, 255);">#define VGC_backend_%.*s (VCL_conf.director[%d])</span><span style="color: rgb(0, 0, 255);">\n</span><span style="color: rgb(0, 0, 255);">"</span><span style="color: rgb(0, 0, 0);">,</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">26</span>             <span style="color: rgb(0, 0, 0);">PF</span>(<span style="color: rgb(0, 0, 0);">t_dir</span><span style="color: rgb(0, 0, 0);">),</span> <span style="color: rgb(0, 0, 0);">tl</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">ndirector</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">27</span>     <span style="color: rgb(0, 0, 0);">vcc_AddDef</span>(<span style="color: rgb(0, 0, 0);">tl</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">t_dir</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">R_BACKEND</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">28</span>     <span style="color: rgb(0, 0, 0);">tl</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">ndirector</span><span style="color: rgb(0, 0, 0);">++</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">29</span> <br /><span style="color: rgb(248, 16, 176);">30</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">if</span> (<span style="color: rgb(0, 0, 0);">vcc_IdIs</span>(<span style="color: rgb(0, 0, 0);">t_first</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 255);">"backend"</span>)) <span style="color: rgb(0, 0, 0);">{</span>     <span style="color: rgb(0, 136, 0); font-style: italic;">/*vcc_IdIs函数查找配置文件中有"backend关键字"， 下同*/</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">31</span>         <span style="color: rgb(0, 0, 0);">vcc_ParseSimpleDirector</span>(<span style="color: rgb(0, 0, 0);">tl</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">t_first</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">t_dir</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">32</span>     <span style="color: rgb(0, 0, 0);">}</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">else</span> <span style="color: rgb(0, 0, 0);">{</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">33</span>         <span style="color: rgb(0, 0, 0);">ExpectErr</span>(<span style="color: rgb(0, 0, 0);">tl</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">ID</span>);      <span style="color: rgb(0, 136, 0); font-style: italic;">/* ID: policy */</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">34</span>         <span style="color: rgb(0, 0, 0);">t_policy</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 0);">tl</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">t</span>;<br /><span style="color: rgb(248, 16, 176);">35</span>         <span style="color: rgb(0, 0, 0);">vcc_NextToken</span>(<span style="color: rgb(0, 0, 0);">tl</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">36</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">37</span>         <span style="color: rgb(0, 0, 128); font-weight: bold;">for</span> (<span style="color: rgb(0, 0, 0);">dl</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 0);">dirlist</span>; <span style="color: rgb(0, 0, 0);">dl</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">name</span> <span style="color: rgb(0, 0, 0);">!=</span> <span style="color: rgb(0, 0, 0);">NULL</span>; <span style="color: rgb(0, 0, 0);">dl</span><span style="color: rgb(0, 0, 0);">++</span>)      <span style="color: rgb(0, 136, 0); font-style: italic;">/*依次查找确定配置文件中规定的director的解析方式*/</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">38</span>             <span style="color: rgb(0, 0, 128); font-weight: bold;">if</span> (<span style="color: rgb(0, 0, 0);">vcc_IdIs</span>(<span style="color: rgb(0, 0, 0);">t_policy</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">dl</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">name</span>))<br /><span style="color: rgb(0, 136, 0); font-style: italic;">39</span>                 <span style="color: rgb(0, 0, 128); font-weight: bold;">break</span>;<br /><span style="color: rgb(248, 16, 176);">40</span>         <span style="color: rgb(0, 0, 128); font-weight: bold;">if</span> (<span style="color: rgb(0, 0, 0);">dl</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">name</span> <span style="color: rgb(0, 0, 0);">==</span> <span style="color: rgb(0, 0, 0);">NULL</span>) <span style="color: rgb(0, 0, 0);">{</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">41</span>             <span style="color: rgb(0, 0, 0);">vsb_printf</span>(<span style="color: rgb(0, 0, 0);">tl</span><span style="color: rgb(0, 0, 0);">-></span>sb<span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 255);">"Unknown director policy: "</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">42</span>             <span style="color: rgb(0, 0, 0);">vcc_ErrToken</span>(<span style="color: rgb(0, 0, 0);">tl</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">t_policy</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">43</span>             <span style="color: rgb(0, 0, 0);">vsb_printf</span>(<span style="color: rgb(0, 0, 0);">tl</span><span style="color: rgb(0, 0, 0);">-></span>sb<span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 255);">" at</span><span style="color: rgb(0, 0, 255);">\n</span><span style="color: rgb(0, 0, 255);">"</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">44</span>             <span style="color: rgb(0, 0, 0);">vcc_ErrWhere</span>(<span style="color: rgb(0, 0, 0);">tl</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">t_policy</span>);<br /><span style="color: rgb(248, 16, 176);">45</span>             <span style="color: rgb(0, 0, 128); font-weight: bold;">return</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">46</span>         <span style="color: rgb(0, 0, 0);">}</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">47</span>         <span style="color: rgb(0, 0, 0);">ExpectErr</span>(<span style="color: rgb(0, 0, 0);">tl</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(128, 0, 128);">'{'</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">48</span>         <span style="color: rgb(0, 0, 0);">vcc_NextToken</span>(<span style="color: rgb(0, 0, 0);">tl</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">49</span>         <span style="color: rgb(0, 0, 0);">dl</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">func</span>(<span style="color: rgb(0, 0, 0);">tl</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">t_policy</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">t_dir</span>);<br /><span style="color: rgb(248, 16, 176);">50</span>         <span style="color: rgb(0, 0, 128); font-weight: bold;">if</span> (<span style="color: rgb(0, 0, 0);">!</span><span style="color: rgb(0, 0, 0);">tl</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">err</span>) <span style="color: rgb(0, 0, 0);">{</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">51</span>             <span style="color: rgb(0, 0, 0);">ExpectErr</span>(<span style="color: rgb(0, 0, 0);">tl</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(128, 0, 128);">'}'</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">52</span>             <span style="color: rgb(0, 0, 0);">vcc_NextToken</span>(<span style="color: rgb(0, 0, 0);">tl</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">53</span>         <span style="color: rgb(0, 0, 0);">}</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">54</span>     <span style="color: rgb(0, 0, 0);">}</span><br /><span style="color: rgb(248, 16, 176);">55</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">if</span> (<span style="color: rgb(0, 0, 0);">tl</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">err</span>) <span style="color: rgb(0, 0, 0);">{</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">56</span>         <span style="color: rgb(0, 0, 0);">vsb_printf</span>(<span style="color: rgb(0, 0, 0);">tl</span><span style="color: rgb(0, 0, 0);">-></span>sb<span style="color: rgb(0, 0, 0);">,</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">57</span>                 <span style="color: rgb(0, 0, 255);">"</span><span style="color: rgb(0, 0, 255);">\n</span><span style="color: rgb(0, 0, 255);">In %.*s specification starting at:</span><span style="color: rgb(0, 0, 255);">\n</span><span style="color: rgb(0, 0, 255);">"</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">PF</span>(<span style="color: rgb(0, 0, 0);">t_first</span>));<br /><span style="color: rgb(0, 136, 0); font-style: italic;">58</span>         <span style="color: rgb(0, 0, 0);">vcc_ErrWhere</span>(<span style="color: rgb(0, 0, 0);">tl</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">t_first</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">59</span>         <span style="color: rgb(0, 0, 128); font-weight: bold;">return</span>;<br /><span style="color: rgb(248, 16, 176);">60</span>     <span style="color: rgb(0, 0, 0);">}</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">61</span> <span style="color: rgb(0, 0, 0);">}</span><br /></div>

  在确立了解析方式之后开始分析round_robin的源文件（cache_dir_round_robin.c）:
     <div style="background: rgb(253, 253, 253) none repeat scroll 0% 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; color: black;"><u>C语言</u></div>
     <div style="font-family: "[object HTMLOptionElement]","Courier New","Bitstream Vera Sans Mono","monospace"; color: rgb(0, 0, 0);" class="source"><span style="color: rgb(0, 136, 0); font-style: italic;">001</span> <span style="color: rgb(0, 128, 128);">#include "config.h"</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">002</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">003</span> <span style="color: rgb(0, 128, 128);">#include <sys/types.h></span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">004</span> <span style="color: rgb(0, 128, 128);">#include <sys/socket.h></span><br /><span style="color: rgb(248, 16, 176);">005</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">006</span> <span style="color: rgb(0, 128, 128);">#include <errno.h></span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">007</span> <span style="color: rgb(0, 128, 128);">#include <stdlib.h></span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">008</span> <span style="color: rgb(0, 128, 128);">#include <string.h></span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">009</span> <span style="color: rgb(0, 128, 128);">#include <unistd.h></span><br /><span style="color: rgb(248, 16, 176);">010</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">011</span> <span style="color: rgb(0, 128, 128);">#include "shmlog.h"</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">012</span> <span style="color: rgb(0, 128, 128);">#include "cache.h"</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">013</span> <span style="color: rgb(0, 128, 128);">#include "cache_backend.h"</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">014</span> <span style="color: rgb(0, 128, 128);">#include "vrt.h"</span><br /><span style="color: rgb(248, 16, 176);">015</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">016</span> <span style="color: rgb(0, 136, 0); font-style: italic;">/*--------------------------------------------------------------------*/</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">017</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">018</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">vdi_round_robin_host</span> <span style="color: rgb(0, 0, 0);">{</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">019</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">backend</span>          <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">backend</span>;       <span style="color: rgb(0, 136, 0); font-style: italic;">/*保存vcl配置文件中的backend的所有信息信息,包括timeout，以及ipv4,ipv6等等信息*/</span><br /><span style="color: rgb(248, 16, 176);">020</span> <span style="color: rgb(0, 0, 0);">};</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">021</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">022</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">vdi_round_robin</span> <span style="color: rgb(0, 0, 0);">{</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">023</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">unsigned</span>            <span style="color: rgb(0, 0, 0);">magic</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">024</span> <span style="color: rgb(0, 128, 128);">#define VDI_ROUND_ROBIN_MAGIC       0x2114a178      </span><span style="color: rgb(0, 136, 0); font-style: italic;">/*魔法数，一般用来检验结构体是否有效*/</span><br /><span style="color: rgb(248, 16, 176);">025</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">director</span>         <span style="color: rgb(0, 0, 0);">dir</span>;                <br /><span style="color: rgb(0, 136, 0); font-style: italic;">026</span>         <span style="color: rgb(0, 136, 0); font-style: italic;">/*这个结构体可以说是本项目的核心结构体，之所以这么说是因为它定义了backend的选择机制(它同样是用的函数指针的方式，</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">027</span> <span style="color: rgb(0, 136, 0); font-style: italic;">        这点跟nginx很想像，该结构体的初始化我们在下面的模块初始化部分介绍)</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">028</span> <span style="color: rgb(0, 136, 0); font-style: italic;">        ，结构体定义是:</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">029</span> <span style="color: rgb(0, 136, 0); font-style: italic;">        struct director {</span><br /><span style="color: rgb(248, 16, 176);">030</span> <span style="color: rgb(0, 136, 0); font-style: italic;">        unsigned        magic;</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">031</span> <span style="color: rgb(0, 136, 0); font-style: italic;">            #define DIRECTOR_MAGIC      0x3336351d</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">032</span> <span style="color: rgb(0, 136, 0); font-style: italic;">        const char      *name;      /*当前负载分配机制的名称*/</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">033</span>         <span style="color: rgb(0, 0, 128); font-weight: bold;">char</span>            <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">vcl_name</span>;      <br /><span style="color: rgb(0, 136, 0); font-style: italic;">034</span>         <span style="color: rgb(0, 0, 0);">vdi_getfd_f</span>     <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">getfd</span>;     <span style="color: rgb(0, 136, 0); font-style: italic;">/*负载分配机制的核心函数指针*/</span><br /><span style="color: rgb(248, 16, 176);">035</span>         <span style="color: rgb(0, 0, 0);">vdi_fini_f</span>      <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">fini</span>;      <span style="color: rgb(0, 136, 0); font-style: italic;">/*退出当前负载分配的函数指针*/</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">036</span>         <span style="color: rgb(0, 0, 0);">vdi_healthy</span>     <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">healthy</span>;   <span style="color: rgb(0, 136, 0); font-style: italic;">/*健康检查函数指针*/</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">037</span>         <span style="color: rgb(0, 0, 128); font-weight: bold;">void</span>            <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">priv</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">038</span>         <span style="color: rgb(0, 0, 0);">};</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">039</span>         <span style="color: rgb(0, 0, 0);">*/</span><br /><span style="color: rgb(248, 16, 176);">040</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">vdi_round_robin_host</span> <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">hosts</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">041</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">unsigned</span>            <span style="color: rgb(0, 0, 0);">nhosts</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">042</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">unsigned</span>            <span style="color: rgb(0, 0, 0);">next_host</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">043</span> <span style="color: rgb(0, 0, 0);">};</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">044</span> <br /><span style="color: rgb(248, 16, 176);">045</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">static</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">vbe_conn</span> <span style="color: rgb(0, 0, 0);">*</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">046</span> <span style="color: rgb(0, 0, 0);">vdi_round_robin_getfd</span>(<span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">sess</span> <span style="color: rgb(0, 0, 0);">*</span>sp)<br /><span style="color: rgb(0, 136, 0); font-style: italic;">047</span> <span style="color: rgb(0, 0, 0);">{</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">048</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">int</span> <span style="color: rgb(0, 0, 0);">i</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">049</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">vdi_round_robin</span> <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">vs</span>;<br /><span style="color: rgb(248, 16, 176);">050</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">backend</span> <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">backend</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">051</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">vbe_conn</span> <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">vbe</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">052</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">053</span>     <span style="color: rgb(0, 0, 0);">CHECK_OBJ_NOTNULL</span>(sp<span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">SESS_MAGIC</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">054</span>     <span style="color: rgb(0, 0, 0);">CHECK_OBJ_NOTNULL</span>(sp<span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">director</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">DIRECTOR_MAGIC</span>);<br /><span style="color: rgb(248, 16, 176);">055</span>     <span style="color: rgb(0, 0, 0);">CAST_OBJ_NOTNULL</span>(<span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">,</span> sp<span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">director</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">priv</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">VDI_ROUND_ROBIN_MAGIC</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">056</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">057</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">for</span> (<span style="color: rgb(0, 0, 0);">i</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 255);">0</span>; <span style="color: rgb(0, 0, 0);">i</span> <span style="color: rgb(0, 0, 0);"><</span> <span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">nhosts</span>; <span style="color: rgb(0, 0, 0);">i</span><span style="color: rgb(0, 0, 0);">++</span>) <span style="color: rgb(0, 0, 0);">{</span>          <span style="color: rgb(0, 136, 0); font-style: italic;">/*round_robin*/</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">058</span>         <span style="color: rgb(0, 0, 0);">backend</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">hosts</span><span style="color: rgb(0, 0, 0);">[</span><span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">next_host</span><span style="color: rgb(0, 0, 0);">].</span><span style="color: rgb(0, 0, 0);">backend</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">059</span>         <span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">next_host</span> <span style="color: rgb(0, 0, 0);">=</span> (<span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">next_host</span> <span style="color: rgb(0, 0, 0);">+</span> <span style="color: rgb(0, 0, 255);">1</span>) <span style="color: rgb(0, 0, 0);">%</span> <span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">nhosts</span>;<br /><span style="color: rgb(248, 16, 176);">060</span>         <span style="color: rgb(0, 0, 128); font-weight: bold;">if</span> (<span style="color: rgb(0, 0, 0);">!</span><span style="color: rgb(0, 0, 0);">backend</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">healthy</span>)<br /><span style="color: rgb(0, 136, 0); font-style: italic;">061</span>             <span style="color: rgb(0, 0, 128); font-weight: bold;">continue</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">062</span>         <span style="color: rgb(0, 0, 0);">vbe</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 0);">VBE_GetVbe</span>(sp<span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">backend</span>);      <span style="color: rgb(0, 136, 0); font-style: italic;">/*和当前选中的backend建立连接*/</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">063</span>         <span style="color: rgb(0, 0, 128); font-weight: bold;">if</span> (<span style="color: rgb(0, 0, 0);">vbe</span> <span style="color: rgb(0, 0, 0);">!=</span> <span style="color: rgb(0, 0, 0);">NULL</span>)<br /><span style="color: rgb(0, 136, 0); font-style: italic;">064</span>             <span style="color: rgb(0, 0, 128); font-weight: bold;">return</span> (<span style="color: rgb(0, 0, 0);">vbe</span>);<br /><span style="color: rgb(248, 16, 176);">065</span>     <span style="color: rgb(0, 0, 0);">}</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">066</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">067</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">return</span> (<span style="color: rgb(0, 0, 0);">NULL</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">068</span> <span style="color: rgb(0, 0, 0);">}</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">069</span> <br /><span style="color: rgb(248, 16, 176);">070</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">static</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">unsigned</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">071</span> <span style="color: rgb(0, 0, 0);">vdi_round_robin_healthy</span>(<span style="color: rgb(0, 0, 128); font-weight: bold;">const</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">sess</span> <span style="color: rgb(0, 0, 0);">*</span>sp)<br /><span style="color: rgb(0, 136, 0); font-style: italic;">072</span> <span style="color: rgb(0, 0, 0);">{</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">073</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">vdi_round_robin</span> <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">vs</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">074</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">int</span> <span style="color: rgb(0, 0, 0);">i</span>;<br /><span style="color: rgb(248, 16, 176);">075</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">076</span>     <span style="color: rgb(0, 0, 0);">CHECK_OBJ_NOTNULL</span>(sp<span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">SESS_MAGIC</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">077</span>     <span style="color: rgb(0, 0, 0);">CHECK_OBJ_NOTNULL</span>(sp<span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">director</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">DIRECTOR_MAGIC</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">078</span>     <span style="color: rgb(0, 0, 0);">CAST_OBJ_NOTNULL</span>(<span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">,</span> sp<span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">director</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">priv</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">VDI_ROUND_ROBIN_MAGIC</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">079</span> <br /><span style="color: rgb(248, 16, 176);">080</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">for</span> (<span style="color: rgb(0, 0, 0);">i</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 255);">0</span>; <span style="color: rgb(0, 0, 0);">i</span> <span style="color: rgb(0, 0, 0);"><</span> <span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">nhosts</span>; <span style="color: rgb(0, 0, 0);">i</span><span style="color: rgb(0, 0, 0);">++</span>) <span style="color: rgb(0, 0, 0);">{</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">081</span>         <span style="color: rgb(0, 0, 128); font-weight: bold;">if</span> (<span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">hosts</span><span style="color: rgb(0, 0, 0);">[</span><span style="color: rgb(0, 0, 0);">i</span><span style="color: rgb(0, 0, 0);">].</span><span style="color: rgb(0, 0, 0);">backend</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">healthy</span>)<br /><span style="color: rgb(0, 136, 0); font-style: italic;">082</span>             <span style="color: rgb(0, 0, 128); font-weight: bold;">return</span> <span style="color: rgb(0, 0, 255);">1</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">083</span>     <span style="color: rgb(0, 0, 0);">}</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">084</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">return</span> <span style="color: rgb(0, 0, 255);">0</span>;<br /><span style="color: rgb(248, 16, 176);">085</span> <span style="color: rgb(0, 0, 0);">}</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">086</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">087</span> <span style="color: rgb(0, 136, 0); font-style: italic;">/*lint -e{818} not const-able */</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">088</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">static</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">void</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">089</span> <span style="color: rgb(0, 0, 0);">vdi_round_robin_fini</span>(<span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">director</span> <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">d</span>)<br /><span style="color: rgb(248, 16, 176);">090</span> <span style="color: rgb(0, 0, 0);">{</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">091</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">int</span> <span style="color: rgb(0, 0, 0);">i</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">092</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">vdi_round_robin</span> <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">vs</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">093</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">vdi_round_robin_host</span> <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">vh</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">094</span> <br /><span style="color: rgb(248, 16, 176);">095</span>     <span style="color: rgb(0, 0, 0);">CHECK_OBJ_NOTNULL</span>(<span style="color: rgb(0, 0, 0);">d</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">DIRECTOR_MAGIC</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">096</span>     <span style="color: rgb(0, 0, 0);">CAST_OBJ_NOTNULL</span>(<span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">d</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">priv</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">VDI_ROUND_ROBIN_MAGIC</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">097</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">098</span>     <span style="color: rgb(0, 0, 0);">vh</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">hosts</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">099</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">for</span> (<span style="color: rgb(0, 0, 0);">i</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 255);">0</span>; <span style="color: rgb(0, 0, 0);">i</span> <span style="color: rgb(0, 0, 0);"><</span> <span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">nhosts</span>; <span style="color: rgb(0, 0, 0);">i</span><span style="color: rgb(0, 0, 0);">++</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">vh</span><span style="color: rgb(0, 0, 0);">++</span>)<br /><span style="color: rgb(248, 16, 176);">100</span>         <span style="color: rgb(0, 0, 0);">VBE_DropRef</span>(<span style="color: rgb(0, 0, 0);">vh</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">backend</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">101</span>     <span style="color: rgb(0, 0, 0);">free</span>(<span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">hosts</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">102</span>     <span style="color: rgb(0, 0, 0);">free</span>(<span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">dir</span><span style="color: rgb(0, 0, 0);">.</span><span style="color: rgb(0, 0, 0);">vcl_name</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">103</span>     <span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">dir</span><span style="color: rgb(0, 0, 0);">.</span><span style="color: rgb(0, 0, 0);">magic</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 255);">0</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">104</span>     <span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">next_host</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 255);">0</span>;<br /><span style="color: rgb(248, 16, 176);">105</span>     <span style="color: rgb(0, 0, 0);">FREE_OBJ</span>(<span style="color: rgb(0, 0, 0);">vs</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">106</span> <span style="color: rgb(0, 0, 0);">}</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">107</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">108</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">void</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">109</span> <span style="color: rgb(0, 0, 0);">VRT_init_dir_round_robin</span>(<span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">cli</span> <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">cli</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">director</span> <span style="color: rgb(0, 0, 0);">**</span>bp<span style="color: rgb(0, 0, 0);">,</span><br /><span style="color: rgb(248, 16, 176);">110</span>         <span style="color: rgb(0, 0, 128); font-weight: bold;">const</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">vrt_dir_round_robin</span> <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">t</span>)<br /><span style="color: rgb(0, 136, 0); font-style: italic;">111</span> <span style="color: rgb(0, 0, 0);">{</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">112</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">vdi_round_robin</span> <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">vs</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">113</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">const</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">vrt_dir_round_robin_entry</span> <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">te</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">114</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">struct</span> <span style="color: rgb(0, 0, 0);">vdi_round_robin_host</span> <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">vh</span>;<br /><span style="color: rgb(248, 16, 176);">115</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">int</span> <span style="color: rgb(0, 0, 0);">i</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">116</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">117</span>     (<span style="color: rgb(0, 0, 128); font-weight: bold;">void</span>)<span style="color: rgb(0, 0, 0);">cli</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">118</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">119</span>     <span style="color: rgb(0, 0, 0);">ALLOC_OBJ</span>(<span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">VDI_ROUND_ROBIN_MAGIC</span>);           <span style="color: rgb(0, 136, 0); font-style: italic;">/*申请结构体vdi_round_robin空间指向vs</span><br /><span style="color: rgb(248, 16, 176);">120</span> <span style="color: rgb(0, 136, 0); font-style: italic;">                                                    ,且把VDI_ROUND_ROBIN_MAGIC的值赋给vs->magic，</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">121</span> <span style="color: rgb(0, 136, 0); font-style: italic;">                                                    表示当前结构体生效*/</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">122</span>     <span style="color: rgb(0, 0, 0);">XXXAN</span>(<span style="color: rgb(0, 0, 0);">vs</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">123</span>     <span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">hosts</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 0);">calloc</span>(<span style="color: rgb(0, 0, 128); font-weight: bold;">sizeof</span> <span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">vh</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">t</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">nmember</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">124</span>     <span style="color: rgb(0, 0, 0);">XXXAN</span>(<span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">hosts</span>);<br /><span style="color: rgb(248, 16, 176);">125</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">126</span>     <span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">dir</span><span style="color: rgb(0, 0, 0);">.</span><span style="color: rgb(0, 0, 0);">magic</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 0);">DIRECTOR_MAGIC</span>;         <br /><span style="color: rgb(0, 136, 0); font-style: italic;">127</span>     <span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">dir</span><span style="color: rgb(0, 0, 0);">.</span><span style="color: rgb(0, 0, 0);">priv</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 0);">vs</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">128</span>     <span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">dir</span><span style="color: rgb(0, 0, 0);">.</span><span style="color: rgb(0, 0, 0);">name</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 255);">"round_robin"</span>;           <span style="color: rgb(0, 136, 0); font-style: italic;">/*以下四行为dir的初始化*/</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">129</span>     <span style="color: rgb(0, 0, 0);">REPLACE</span>(<span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">dir</span><span style="color: rgb(0, 0, 0);">.</span><span style="color: rgb(0, 0, 0);">vcl_name</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">t</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">name</span>);<br /><span style="color: rgb(248, 16, 176);">130</span>     <span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">dir</span><span style="color: rgb(0, 0, 0);">.</span><span style="color: rgb(0, 0, 0);">getfd</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 0);">vdi_round_robin_getfd</span>;      <span style="color: rgb(0, 136, 0); font-style: italic;">/*函数指针初始化*/</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">131</span>     <span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">dir</span><span style="color: rgb(0, 0, 0);">.</span><span style="color: rgb(0, 0, 0);">fini</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 0);">vdi_round_robin_fini</span>;        <span style="color: rgb(0, 136, 0); font-style: italic;">/*同上*/</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">132</span>     <span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">dir</span><span style="color: rgb(0, 0, 0);">.</span><span style="color: rgb(0, 0, 0);">healthy</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 0);">vdi_round_robin_healthy</span>;      <span style="color: rgb(0, 136, 0); font-style: italic;">/*同上*/</span><br /><span style="color: rgb(0, 136, 0); font-style: italic;">133</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">134</span>     <span style="color: rgb(0, 0, 0);">vh</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">hosts</span>;<br /><span style="color: rgb(248, 16, 176);">135</span>     <span style="color: rgb(0, 0, 0);">te</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 0);">t</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">members</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">136</span>     <span style="color: rgb(0, 0, 128); font-weight: bold;">for</span> (<span style="color: rgb(0, 0, 0);">i</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 255);">0</span>; <span style="color: rgb(0, 0, 0);">i</span> <span style="color: rgb(0, 0, 0);"><</span> <span style="color: rgb(0, 0, 0);">t</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">nmember</span>; <span style="color: rgb(0, 0, 0);">i</span><span style="color: rgb(0, 0, 0);">++</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">vh</span><span style="color: rgb(0, 0, 0);">++</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">te</span><span style="color: rgb(0, 0, 0);">++</span>)<br /><span style="color: rgb(0, 136, 0); font-style: italic;">137</span>         <span style="color: rgb(0, 0, 0);">vh</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">backend</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 0);">VBE_AddBackend</span>(<span style="color: rgb(0, 0, 0);">cli</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">te</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">host</span>);<br /><span style="color: rgb(0, 136, 0); font-style: italic;">138</span>     <span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">nhosts</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 0);">t</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">nmember</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">139</span>     <span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">next_host</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 255);">0</span>;<br /><span style="color: rgb(248, 16, 176);">140</span> <br /><span style="color: rgb(0, 136, 0); font-style: italic;">141</span>     <span style="color: rgb(0, 0, 0);">*</span>bp <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 0);">&</span><span style="color: rgb(0, 0, 0);">vs</span><span style="color: rgb(0, 0, 0);">-></span><span style="color: rgb(0, 0, 0);">dir</span>;<br /><span style="color: rgb(0, 136, 0); font-style: italic;">142</span> <span style="color: rgb(0, 0, 0);">}</span><br /></div>

  到此我们已经对varnish后端负载分配模块实现机制有了一定了解:
查找director方式例如"round_robin","random"等等，在配置文件中找到上述关键字后，确定其对应的解析方式（因为每种负载
分配机制可能对应有自己独特的一些关键字）,解析完毕，把信息添加到相应的结构体中，记录这些信息，然后进入当前负载分配模块对应的初始化函数（例如"VRT_init_dir_round_robin()"),申请当前模块对应的结构体，使上述的函数指针指向当前模块相应的处理函数。当需要负载分配的时候就直接调用当前模块函数指针所指函数即可。整个实现过程与nginx的模块处理方式基本相同。

对于ip_hash的解析我们选取跟round-robin同样的解析方式，对于结构体做了如下修改：

```
static const struct dirlist {
    const char  *name;
    parsedirector_f *func;
} dirlist[] = {
    { "random",     vcc_ParseRandomDirector },         
    { "round-robin",    vcc_ParseRoundRobinDirector },
    { "ip_hash",        vcc_ParseRoundRobinDirector },
    { NULL,     NULL }
}
```

新添加了cache_dir_ip_hash文件.[略]

  